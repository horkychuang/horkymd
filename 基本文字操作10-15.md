# Ch 10 文字處理簡介

# 基本文字操作(1)

- 資料處理中最討厭的部分就是文字的處理，他的自由度高暗示著資料可能很亂，因此文字處理需要非常多樣化的函數

– 在R的字串處理中要小心注意character、factor、numeric這三種類別的誤轉換和混用，尤其是factor是一種很討厭的格式，因為它在轉成數字和字串的時候，常常會變成跟原本不一樣的東西

- 我們在這裡先介紹幾個簡單的字串處理函數：

1-1. 字串黏合(不同物件)

```
paste("A", "B", sep = "")
## [1] "AB"
```

1-2. 字串黏合(同物件)

```
paste(c("A", "B"), collapse = "")
## [1] "AB"
```

1. 字串分割

```
strsplit("A.B", split = "." , fixed = TRUE)
## [[1]]
## [1] "A" "B"
```

1. 部份穩合

```
x = c("AB", "AA")
grepl("B", x)
## [1]  TRUE FALSE
grepl("A", x)
## [1] TRUE TRUE
```

1. 回傳出現位置

```
x = c("ABABC", "CCAAE")
gregexpr("A", x)
## [[1]]
## [1] 1 3
## attr(,"match.length")
## [1] 1 1
## attr(,"useBytes")
## [1] TRUE
## 
## [[2]]
## [1] 3 4
## attr(,"match.length")
## [1] 1 1
## attr(,"useBytes")
## [1] TRUE
```

1. 子字串

```
substr("ndmc1234", 1, 4)
## [1] "ndmc"
```

1. 字元取代

```
x = "AABB"
gsub("A", "C", x)
## [1] "CCBB"
```

1. 計算字串長度

```
x = c("A","AAA","AAAAA")
nchar(x)
## [1] 1 3 5
```

1. 大小寫切換

```
tolower("aBcDe")
## [1] "abcde"
toupper("aBcDe")
## [1] "ABCDE"
```

# 基本文字操作(2)

- 透過上述這些字串處理函數的組合，我們將可以做到許多神奇的事情，像是假設我們現在有一組email信箱，而你想要把其中的「@」之前的作為使用者帳號，那該怎麼辦呢?

– 這是第一種作法，使用函數「strsplit」做字串分割：

```
emails = c("xup6fup@mail.ndmctsgh.edu.tw", "xup6fup0629@gmail.com")

n.account = length(emails)
accounts = rep("", n.account)

splited_emails = strsplit(emails, split = "@" , fixed = TRUE)

for (i in 1:n.account) {
  accounts[i] = splited_emails[[i]][1]
}

accounts
## [1] "xup6fup"     "xup6fup0629"
```

– 這是第二種作法，先使用函數「gregexpr」回傳「@」出現位置，再使用函數｢substr｣分離字串：

```
emails = c("xup6fup@mail.ndmctsgh.edu.tw", "xup6fup0629@gmail.com")

n.account = length(emails)
accounts = rep("", n.account)

symbol_pos = gregexpr("@" , emails, fixed = TRUE)

for (i in 1:n.account) {
  accounts[i] = substr(emails[i], 1, symbol_pos[[i]][1] - 1)
}

accounts
## [1] "xup6fup"     "xup6fup0629"
```

用到函數「readLines」來進行讀檔：

```
dat = readLines("pirate.txt", encoding = "UTF-8")
head(dat)
## [1] "2013年9月份海盜案件紀要(東南亞地區)" "資料來源:馬來西亞海盜報案中心(PRC) "
## [3] "1.\t日期：2013年9月3日"              "時間：世界時間1410"                 
## [5] "經緯度：北緯10度13分、東經107度02分" "地點：越南"
```

- 首先我們要先把經緯度切割出來：

```
dat = readLines("pirate.txt", encoding = "UTF-8")

dat1 = dat[grepl("經緯度：", dat)]
dat2 = gsub('經緯度：', "", dat1)
dat3 = strsplit(dat2, '、')

lat = rep(NA, length(dat3))
lon = rep(NA, length(dat3))

for (i in 1:length(dat3)) {
  
  if (grepl('南', dat3[[i]][[1]])) {lat_sign = -1} else {lat_sign = 1}
  current_lat = strsplit(dat3[[i]][[1]], '度')
  current_lat = gsub('北緯', '', current_lat[[1]])
  current_lat = gsub('南緯', '', current_lat)
  current_lat = gsub('分', '', current_lat)
  current_lat = as.numeric(current_lat)
  
  lat[i] = (current_lat[1] + current_lat[2] / 60) * lat_sign
    
  if (grepl('西', dat3[[i]][[2]])) {lon_sign = -1} else {lon_sign = 1}
  current_lon = strsplit(dat3[[i]][[2]], '度')
  current_lon = gsub('東經', '', current_lon[[1]])
  current_lon = gsub('西經', '', current_lon)
  current_lon = gsub('分', '', current_lon)
  current_lon = as.numeric(current_lon)
  
  lon[i] = (current_lon[1] + current_lon[2] / 60) * lon_sign
  
}
```

# 正則表達式(1)

- 字串處理的討厭之處在於其高複雜度，有時候我們要找出的patten是非常複雜的組合，像是我們想要找出下列字串的數字部分，這時候我們要怎樣處理呢?

– 這時候我們可以利用「正則表達式」來描述某些patten的位置，像是這樣：

```
x = c("abc123", "abcd12!34")

gsub("[^0-9]", "", x)
## [1] "123"  "1234"
```

- 這個「[^0-9]」的部分意思是找出不屬於0-9的所有字元，而函數「gsub」則協助我們把這些字元取代為空字元，如此我們就能只留下數字的部分

– 下面是所有中括號的用法：

```
## [1] "[Aa]     :: A 或 a"
## [1] "[^1-9]   :: not 1:9"
## [1] "[1-9]    :: 1:9"
## [1] "[a-z]    :: a b c ... z"
## [1] "[A-Z]    :: A B C ... Z"
## [1] "[a-zA-Z] :: 所有英文字母"
## [1] "[W-z]    :: WXYZabc....z"
## [1] "[w-Z]    :: 不可使用!"
```

# 正則表達式(2)

- 另外我們可以使用大括號來描述我們可以允許的條件，像是這樣：

```
gsub(" {1,}", " ", "nice to  meet   you.")
## [1] "nice to meet you."
```

- 這行指令說明我們要把1個以上的連續空白改成只有1個空白，你也可以用下列規則解決：

```
## [1] "*        :: {0, }   至少出現 0次, 最多無限多次"
## [1] "+        :: {1, }   至少出現 1次, 最多無限多次"
## [1] "?        :: {0,1}   至少出現 0次, 最多出現 1次"
gsub(" +", " ", "nice to  meet   you.")
## [1] "nice to meet you."
```

# 正則表達式(3)

- 小括號則是用來描述延伸字串的寫法，像是我們可以用這種方式來編寫：

```
x = c("medicine", "medical")

grepl("medic(ine|al)", x)
## [1] TRUE TRUE
```

- 除了「|」符號能拿來描述「or」之外，還有下面符號能使用

```
## [1] "$        :: 字尾限定"
## [1] "^        :: 字首限定"
## [1] "|        :: \"ABC|EFG\" --> grep(\"ABC\"or\"DEF\",x)"
## [1] ".        :: 任意字元"
x = c("how are you", "hi Jack", "nice to meet you")

grepl("you$", x)
## [1]  TRUE FALSE  TRUE
grepl("^h", x)
## [1]  TRUE  TRUE FALSE
grepl("h.*a", x)
## [1]  TRUE  TRUE FALSE
```

# 正則表達式(4)

- 讓我們用正則表達式有效率的找出經緯度的位置吧！

```
dat = readLines("pirate.txt", encoding = "UTF-8")

area.dat = grep("經緯度", dat, value = TRUE)
lat.pos = gregexpr("[北南]緯[0-9]+度[0-9]+\\.*[0-9]*分", area.dat)
lon.pos = gregexpr("[東西]經[0-9]+度[0-9]+\\.*[0-9]*分", area.dat)

n.area = length(area.dat)
lat.char = character(n.area)
lon.char = character(n.area)

for (i in 1:n.area) {
  
  lat.char[i] = substr(area.dat[i], lat.pos[[i]], lat.pos[[i]] + attr(lat.pos[[i]], "match.length") - 1)
  lon.char[i] = substr(area.dat[i], lon.pos[[i]], lon.pos[[i]] + attr(lon.pos[[i]], "match.length") - 1)
  
}

lat.char
## [1] "北緯10度13分"  "北緯1度9.18分" "南緯7度9.9分"  "南緯0度16.4分"
## [5] "北緯1度7分"    "北緯4度52分"   "北緯3度58分"
lon.char
## [1] "東經107度02分"    "東經103度34.44分" "東經112度40.2分"  "東經117度41.7分" 
## [5] "東經103度37分"    "東經104度5分"     "東經98度45分"
```

- 字串取得後，文字轉數字就變得非常容易了，我們可以把單位切成3個部份：

```
lat = numeric(n.area)
lon = numeric(n.area)

for (i in 1:n.area) {
  
  splited_lat = strsplit(lat.char[i], "度")[[1]]
  splited_lat = gsub("[^0-9\\.]", "", splited_lat)
  splited_lat = as.numeric(splited_lat)
  lat[i] = splited_lat[1] + splited_lat[2] / 60 
  if (grepl("南緯", lat.char[i])) {lat[i] = -lat[i]}
  
  splited_lon = strsplit(lon.char[i], "度")[[1]]
  splited_lon = gsub("[^0-9\\.]", "", splited_lon)
  splited_lon = as.numeric(splited_lon)
  lon[i] = splited_lon[1] + splited_lon[2] / 60 
  if (grepl("西經", lon.char[i])) {lon[i] = -lon[i]}
  
}

lat
## [1] 10.2166667  1.1530000 -7.1650000 -0.2733333  1.1166667  4.8666667  3.9666667
lon
## [1] 107.0333 103.5740 112.6700 117.6950 103.6167 104.0833  98.7500
```

- 下列這些字串分別是50個人所設定的密碼：

```
x = c("KUJYW3A", "6yp7cfsxd", "fopKOLb", "0Ti5j9CVo", "YbdFfTy", "pqVb5RSO",
      "VqGAlm3WNw", "MBsnhKwAjT", "6qZDKlh", "2otWgVA", "q0bnD38", "PhEiD41",
      "MLf9naK", "Nn64XcER5", "MEGBXUL1", "bAeoV5wt8T", "qvjJfYMX", "vWcJRygs",
      "xuvDp2aB", "GuiraLx", "oNGYFgq4p", "KZoHvBO", "fzti6jekwd", "dLISnCv", 
      "LTHXGow", "sz4QhX5", "JBELeHr", "mgG6VAOD", "zaeNCRWwb", "UTVLBDxrth",
      "3LXAcJHzk", "7Tc0RJD", "xQvBtmOR", "vD3gjl6Z", "gZ2tShAVY", "9DQwZop",
      "YNZh6EaODH", "UjTMAne7D", "lyGTxu4", "7Iy1G4gPK", "rPZ0tlqM", "goLsQMc2",
      "bcvemkjftd", "Z6yrYx3q", "ReTYMxqlt", "Sd6BEHVCN", "Th8ZYWigq", "tqgr0oud", 
      "rAsRu4dw", "93w1nxe")
```

- 我們的密碼規定如下，請你檢查出不符合規定的位置有哪些：

1. 密碼長度需要8碼以上(含8碼)
2. 密碼需要同時包含「大寫」、「小寫」、「數字」，只要缺少任一項即為有問題

- 假設你夠快解決這個問題，那我們來個更進階的問題，如果我們要找出同時包含2個以上「大寫」、2個以上「小寫」、2個以上「數字」的密碼在哪，你找的出來嗎?

```
## [1]  4 14 16 34 40 44
```

```
which(grepl("[A-Z].*[A-Z]", x) & grepl("[a-z].*[a-z]", x) & grepl("[0-9].*[0-9]", x) & nchar(x) >= 8)
## [1]  4 14 16 34 40 44
```

# Ch11 HTML剖析及網頁爬蟲實作

# HTML基本語法介紹(1)

- 我們已經學會了簡單的文字處理，下一個目標就是我們有沒有可能寫出一個程式從網頁上自動擷取我們想知道的資訊呢?

– 所謂的網頁背後都是被一種叫做「HTML」的語法，而你的IE、Chrome等瀏覽器其實就是負責解析「HTML」的語法，並把他呈現成你想看到的樣子。

- 這裡我們從一個簡單的網頁開始看起，臺大醫院急診部提供了一個[國立臺灣大學醫學院附設醫院 急診即時資訊](https://reg.ntuh.gov.tw/EmgInfoBoard/NTUHEmgInfo.aspx)，這是一個非常簡單的網頁：

– 你可以參考[全國重度級急救責任醫院急診即時訊息總覽](https://www.nhi.gov.tw/SysService/SevereAcuteHospital.aspx?menu=18&menu_id=683&WD_ID=1119)找到更多醫院

對著頁面點擊右鍵，你將能看到「檢視網頁原始碼」，接著你將能看到這個頁面

# HTML基本語法介紹(2)

- 你可以發現HTML的語法通常是透過「<」與「>」來描述要呈現的物件，他是在描述網頁的標題(呈現在分頁上)，因此假設我們想要表格內的數據，我們將能透過解析「<」與「>」的部分來取得！
- 在解析這個網頁之前，我們要先有能力把整個網頁的資訊讀進來，這裡我們可以用函數「scan」：

```
URL = "https://reg.ntuh.gov.tw/EmgInfoBoard/NTUHEmgInfo.aspx"

txt = scan(URL, what = "character", encoding = "UTF-8", quiet = TRUE)

head(txt, 15)
##  [1] "<!DOCTYPE"                              
##  [2] "html>"                                  
##  [3] "<html"                                  
##  [4] "xmlns=\"http://www.w3.org/1999/xhtml\">"
##  [5] "<head><title>"                          
##  [6] "國立臺灣大學醫學院附設醫院"             
##  [7] "急診即時資訊"                           
##  [8] "</title>"                               
##  [9] "<style"                                 
## [10] "type=\"text/css\">"                     
## [11] "table,"                                 
## [12] "div"                                    
## [13] "{"                                      
## [14] "font-family:"                           
## [15] "verdana,"
```

- 你應該會發現讀進來的時候只要遇到空白或是換行符號他就會自動下一行，而非連續的字串對我們來說並不好處理，讓我們再用函數「paste」把他們貼成一個長字串：

```
txt_new = paste(txt, sep = "", collapse = " ")
```

# HTML基本語法介紹(3)

- 那現在我們要如何把這個網頁的title擷取下來呢?我們可以利用學到的正則表達式：

```
TITLE.pos = gregexpr("<title>.*</title>", txt_new)
start.TITLE.pos = TITLE.pos[[1]][1]
end.TITLE.pos = start.TITLE.pos + attr(TITLE.pos[[1]], "match.length")[1] - 1

TITLE.word = substr(txt_new, start.TITLE.pos, end.TITLE.pos)

TITLE.word
## [1] "<title> 國立臺灣大學醫學院附設醫院 急診即時資訊 </title>"
```

- 如果你想要乾淨一點的標題，我們可以再把他用函數「gsub」清乾淨：

```
TITLE.word = gsub("<title>", "", TITLE.word)
TITLE.word = gsub("</title>", "", TITLE.word)
TITLE.word
## [1] " 國立臺灣大學醫學院附設醫院 急診即時資訊 "
```

# HTML基本語法介紹(4)

- 有了這樣的概念之後，我們再看看一個更複雜的例子，也就是我們想抓到「等候掛號人數：」後面的人數：
- 這個例子的複雜之處在於我們沒有辦法簡單的利用正則表達式來抓取他，這是因為以tr結尾的有非常多，所以我們必須分開抓取：

```
start.pos = gregexpr("<tr>", txt_new)
end.pos = gregexpr("</tr>", txt_new)

i = 1
sub.start.pos = start.pos[[1]][i]
sub.end.pos = end.pos[[1]][i] + attr(end.pos[[1]], "match.length")[i] - 1

sub_txt = substr(txt_new, sub.start.pos, sub.end.pos)
sub_txt
## [1] "<tr> <td>等候掛號人數：</td> <td> 0人</td> </tr>"
```

- 如果「等候掛號人數」，你可以透過這種方式拿取：

```
sub_txt = gsub('等候掛號人數：', '', sub_txt)
sub_txt = gsub('</?tr>', '', sub_txt)
sub_txt = gsub('</?td>', '', sub_txt)
sub_txt = gsub(' ', '', sub_txt)
sub_txt
## [1] "0人"
```

寫一個自訂函數，只要執行就可以直接產生「等候掛號人數」、「等候看診人數」、「等候住院人數」、「等候ICU人數」、「等候推床人數」等資訊

```
NTU_info = function () {
  
  result = data.frame(item = c('等候掛號人數', '等候看診人數', '等候住院人數', '等候ICU人數', '等候推床人數'),
                      info = NA,
                      stringsAsFactors = FALSE)
  
  URL = "https://reg.ntuh.gov.tw/EmgInfoBoard/NTUHEmgInfo.aspx"
  
  txt = scan(URL, what = "character", encoding = "UTF-8", quiet = TRUE)
  txt_new = paste(txt, sep = "", collapse = " ")
  
  start.pos = gregexpr("<tr>", txt_new)
  end.pos = gregexpr("</tr>", txt_new)
  
  for (i in 1:5) {
    
    sub.start.pos = start.pos[[1]][i]
    sub.end.pos = end.pos[[1]][i] + attr(end.pos[[1]], "match.length")[i] - 1
    
    sub_txt = substr(txt_new, sub.start.pos, sub.end.pos)
    sub_txt = gsub('等.*：', '', sub_txt)
    sub_txt = gsub('</?tr>', '', sub_txt)
    sub_txt = gsub('</?td>', '', sub_txt)
    result[i,'info'] = gsub(' ', '', sub_txt)
    
  }

  result
  
}

NTU_info()
```

# 利用套件執行任務(1)

- 經過剛剛的練習，你應該對於從網頁上自動擷取想要的資訊已經有些熟悉了，但你應該有注意到整個過程有點繁瑣，所以我們試著用套件來解決這個問題吧：

– 套件「rvest」能協助我們做這件事情，套件內的函數「read_html」能協助我們讀取網頁，而函數「html_nodes」能幫助我們把某種標籤的文字萃取出來，最後「html_text」能幫助我們把標籤通通去掉：

```
library(rvest)

URL = "https://reg.ntuh.gov.tw/EmgInfoBoard/NTUHEmgInfo.aspx"

website = read_html(URL)

needed_txt = website %>% html_nodes("tr") %>% html_text()
needed_txt
## [1] "等候掛號人數：\r\n                        \r\n                            0人\r\n                    "    
## [2] "等候看診人數：\r\n                        \r\n                            0人\r\n                    "    
## [3] "等候住院人數：\r\n                        \r\n                            53人\r\n                    "   
## [4] "等候ICU人數：\r\n                        \r\n                            0人\r\n                    "     
## [5] "等候推床人數：\r\n                        \r\n                            0人\r\n                    "    
## [6] "兒科等候看診人數：\r\n                        \r\n                            0人\r\n                    "
## [7] "兒科等候住院人數：\r\n                        \r\n                            0人\r\n                    "
## [8] "兒科等候ICU人數：\r\n                        \r\n                            0人\r\n                    " 
## [9] "資料擷取時間：2021/7/9 上午 08:35:10\r\n   
```

# 利用套件執行任務(2)

- 那現在我們來做一個有趣的任務，PTT有一個看板叫做[AllTogether](https://www.ptt.cc/bbs/AllTogether/)，上面有許多單身男女會在上面徵男友或女友。
- 讓我們解析一下這個網頁吧，其中你會注意到我們對「a」這個標籤是有興趣的，因為它包含著文章的連結：

```
URL = "https://www.ptt.cc/bbs/AllTogether/index3245.html"
website = read_html(URL)

needed_html = website %>% html_nodes("a")
needed_html
## {xml_nodeset (67)}
##  [1] <a id="logo" href="/bbs/">批踢踢實業坊</a>
##  [2] <a class="board" href="/bbs/AllTogether/index.html"><span class="board-l ...
##  [3] <a class="right small" href="/about.html">關於我們</a>
##  [4] <a class="right small" href="/contact.html">聯絡資訊</a>
##  [5] <a class="btn selected" href="/bbs/AllTogether/index.html">看板</a>
##  [6] <a class="btn" href="/man/AllTogether/index.html">精華區</a>
##  [7] <a class="btn wide" href="/bbs/AllTogether/index1.html">最舊</a>
##  [8] <a class="btn wide" href="/bbs/AllTogether/index3244.html"><U+2039> 上頁</a>
##  [9] <a class="btn wide" href="/bbs/AllTogether/index3246.html">下頁 <U+203A></a>
## [10] <a class="btn wide" href="/bbs/AllTogether/index.html">最新</a>
## [11] <a href="/bbs/AllTogether/M.1600670546.A.B1C.html">[徵女] 台北吃燒肉 牛排</a>
## [12] <a href="/bbs/AllTogether/search?q=thread%3A%5B%E5%BE%B5%E5%A5%B3%5D+%E5 ...
## [13] <a href="/bbs/AllTogether/search?q=author%3Aj2046g">搜尋看板內 j2046g 的文章</a>
## [14] <a href="/bbs/AllTogether/M.1600680270.A.B43.html">[徵男] 高雄今天一起喝一杯吧</a>
## [15] <a href="/bbs/AllTogether/search?q=thread%3A%5B%E5%BE%B5%E7%94%B7%5D+%E9 ...
## [16] <a href="/bbs/AllTogether/search?q=author%3Ababyqoo390">搜尋看板內 babyqoo390 ...
## [17] <a href="/bbs/AllTogether/M.1600690355.A.667.html">[徵女] 有玩過桌球的女生</a>
## [18] <a href="/bbs/AllTogether/search?q=thread%3A%5B%E5%BE%B5%E5%A5%B3%5D+%E6 ...
## [19] <a href="/bbs/AllTogether/search?q=author%3Aandy19930905">搜尋看板內 andy1993 ...
## [20] <a href="/bbs/AllTogether/M.1600694448.A.12F.html">[聯誼] 徵人一起參加聯誼派對</a>
## ...
needed_txt = needed_html %>% html_text()
needed_txt
##  [1] "批踢踢實業坊"                               
##  [2] "看板 AllTogether"                           
##  [3] "關於我們"                                   
##  [4] "聯絡資訊"                                   
##  [5] "看板"                                       
##  [6] "精華區"                                     
##  [7] "最舊"                                       
##  [8] "<U+2039> 上頁"                              
##  [9] "下頁 <U+203A>"                              
## [10] "最新"                                       
## [11] "[徵女] 台北吃燒肉 牛排"                     
## [12] "搜尋同標題文章"                             
## [13] "搜尋看板內 j2046g 的文章"                   
## [14] "[徵男] 高雄今天一起喝一杯吧"                
## [15] "搜尋同標題文章"                             
## [16] "搜尋看板內 babyqoo390 的文章"               
## [17] "[徵女] 有玩過桌球的女生"                    
## [18] "搜尋同標題文章"                             
## [19] "搜尋看板內 andy19930905 的文章"             
## [20] "[聯誼] 徵人一起參加聯誼派對"                
## [21] "搜尋同標題文章"                             
## [22] "搜尋看板內 honey99 的文章"                  
## [23] "[徵女] 台中天氣晴"                          
## [24] "搜尋同標題文章"                             
## [25] "搜尋看板內 Lethe1314 的文章"                
## [26] "[徵女] 台北男生徵友"                        
## [27] "搜尋同標題文章"                             
## [28] "搜尋看板內 nanostick 的文章"                
## [29] "[大心] 我們結婚啦!!!"                       
## [30] "搜尋同標題文章"                             
## [31] "搜尋看板內 Birdmaster 的文章"               
## [32] "[徵女] 認真找女朋友"                        
## [33] "搜尋同標題文章"                             
## [34] "搜尋看板內 yiyuyi 的文章"                   
## [35] "[聯誼] 9/26(六)台北免費歡樂桌遊聯誼交友派對"
## [36] "搜尋同標題文章"                             
## [37] "搜尋看板內 tianxingren 的文章"              
## [38] "[徵女] 一起為人生塗點顏色"                  
## [39] "搜尋同標題文章"                             
## [40] "搜尋看板內 jkeuy 的文章"                    
## [41] "[徵女] 關鍵字: 健談 幽默 個性好 人品好"     
## [42] "搜尋同標題文章"                             
## [43] "搜尋看板內 o500521 的文章"                  
## [44] "[徵女] 9/23板橋音樂會"                      
## [45] "搜尋同標題文章"                             
## [46] "搜尋看板內 playing808 的文章"               
## [47] "[徵男] 台北週二中午看天能"                  
## [48] "搜尋同標題文章"                             
## [49] "搜尋看板內 bhaniy0407 的文章"               
## [50] "[徵女] 竹北30蠍男徵友"                      
## [51] "搜尋同標題文章"                             
## [52] "搜尋看板內 SellCall 的文章"                 
## [53] "[徵女] 身長一米六五"                        
## [54] "搜尋同標題文章"                             
## [55] "搜尋看板內 junzi 的文章"                    
## [56] "[徵女] 隨意鳥吃飯"                          
## [57] "搜尋同標題文章"                             
## [58] "搜尋看板內 smallwoei 的文章"                
## [59] "[徵女] 珍惜每個緣分"                        
## [60] "搜尋同標題文章"                             
## [61] "搜尋看板內 pig810627 的文章"                
## [62] "[徵女] 台北下午茶兜風"                      
## [63] "搜尋同標題文章"                             
## [64] "搜尋看板內 Karp 的文章"                     
## [65] "[徵女] 北部 下個月陪我過生日"               
## [66] "搜尋同標題文章"                             
## [67] "搜尋看板內 shoggoth 的文章"
```

- 我比較有興趣的是徵男文，我們用這種方式能找到徵男文的位置在哪：

```
intrested_pos = grep("[徵男]", needed_txt, fixed = TRUE)
needed_txt[intrested_pos]
## [1] "[徵男] 高雄今天一起喝一杯吧" "[徵男] 台北週二中午看天能"
```

- 我更有興趣的可能是這篇文章的連結，你會發現文章連結藏在needed_html裡面，我們可以透過這種方式拿到：

```
needed_link = needed_html[intrested_pos] %>% html_attr("href")
```

# 利用套件執行任務(3)

- 現在我們到其中一篇文章來看看，我們想要知道這篇文章的基本資料，你會發現他們都被span標籤給抓到，但跟span有關的有太多了，我們注意到他有一個特殊的class叫做article-meta-value，我們可以用這種方式叫到他

```
i = 1
sub_link = paste("https://www.ptt.cc", needed_link[i], sep = "")
sub_website = read_html(sub_link) 

article_info = sub_website %>% html_nodes(".article-meta-value")
article_info
## {xml_nodeset (4)}
## [1] <span class="article-meta-value">babyqoo390 (ann)</span>
## [2] <span class="article-meta-value">AllTogether</span>
## [3] <span class="article-meta-value">[徵男] 高雄今天一起喝一杯吧</span>
## [4] <span class="article-meta-value">Mon Sep 21 17:24:28 2020</span>
```

- 有沒有覺得用套件很方便！

- 能夠隨時調閱最近的10篇徵男文，你需要完成下面的功能：

1. 最新的頁面在https://www.ptt.cc/bbs/AllTogether/index.html，你需要透過下面的方式找出上一頁的連結：

```
URL = "https://www.ptt.cc/bbs/AllTogether/index.html"
website = read_html(URL)

website %>% html_nodes("a") %>% .[8] %>% html_attr("href")
```

```
## [1] "/bbs/AllTogether/index3714.html"
```

1. 接著，從最新的頁面開始抓取徵男文的標題與連結，直到抓到10篇為止！
2. 抓滿10篇之後，進去連結內去看看發文者ID以及時間，並把他填入表格之內

```
library(rvest)
my_table = matrix("", nrow = 100, ncol = 4)
colnames(my_table) = c("Title", "url", "ID", "time")

URL = "https://www.ptt.cc/bbs/AllTogether/index.html"
current_id = 1

for (i in 1:10) {
  
  website = read_html(URL)
  needed_html = website %>% html_nodes("a")
  needed_txt = needed_html %>% html_text()
  intrested_pos = grep("[徵男]", needed_txt, fixed = TRUE)
  
  if (length(intrested_pos) > 0) {
    
    for (j in intrested_pos) {
      
      if (current_id <= 10) {
        my_table[current_id, 1] = needed_txt[j]
        my_table[current_id, 2] = needed_html[j] %>% html_attr("href")
      }
      
    current_id = current_id + 1
    
    }
    
  }
  
  if (current_id > 10) {
    break
  }
  
  next_page = website %>% html_nodes("a") %>% .[8] %>% html_attr("href")
  URL = paste0("https://www.ptt.cc", next_page, sep = "")
  
}

for (i in 1:nrow(my_table)) {
  
  sub_URL = paste("https://www.ptt.cc", my_table[i, 2], sep = "")
  sub_website = read_html(sub_URL)
  article_info = sub_website %>% html_nodes(".article-meta-value") %>% html_text()
  my_table[i, 3] = article_info[1]
  my_table[i, 4] = article_info[4]
  
}

my_table
```

# 使用cookie(1)

- 如果你用前面的方法訪問八卦(Gossiping)版，你會發現你沒有辦法做：

```
URL = 'https://www.ptt.cc/bbs/Gossiping/index.html'

website = read_html(URL)
website
## {html_document}
## <html>
## [1] <head>\n<meta http-equiv="Content-Type" content="text/html; charset=UTF-8 ...
## [2] <body>\n\t\t\n<div class="bbs-screen bbs-content">\n    <div class="over1 ...
```

- 這個原因是因為直接訪問八卦(Gossiping)版你會看到這個畫面

- 所以你必須告訴網站說你已經滿18歲了，但這件事情該怎麼做呢?

# 使用cookie(2)

- 我們需要先使用一般的瀏覽器訪問該網站(最好使用無痕視窗)，接著你在選擇滿18歲以後你的電腦將會記錄下這個答案，我們叫他cookie。

- 使用cookie讀取網頁需要用到套件「RCurl」，讓我們看看要怎樣處理：

```
library(RCurl)

URL = 'https://www.ptt.cc/bbs/Gossiping/index.html'
curl = getCurlHandle()
curlSetOpt(cookie = "over18=1", followlocation = TRUE, curl = curl)
## An object of class "CURLHandle"
## Slot "ref":
## <pointer: 0x0000000039eb0030>
html_character = getURL(URL, curl = curl)

website = read_html(html_character)
needed_html = website %>% html_nodes("a")
needed_txt = needed_html %>% html_text()
needed_txt
```

- 試著找出最近的10篇新聞吧：

```
library(RCurl)
library(rvest)

my_table = matrix("", nrow = 10, ncol = 2)
colnames(my_table) = c("Title", "url")

URL = 'https://www.ptt.cc/bbs/Gossiping/index.html'
curl = getCurlHandle()
curlSetOpt(cookie = "over18=1", followlocation = TRUE, curl = curl)
## An object of class "CURLHandle"
## Slot "ref":
## <pointer: 0x0000000039bdb170>

current_id = 1

for (i in 1:10) {
  
  html_character = getURL(URL, curl = curl)
  website = read_html(html_character)
  
  needed_html = website %>% html_nodes("a")
  needed_txt = needed_html %>% html_text()
  intrested_pos = which(grepl("[新聞]", needed_txt, fixed = TRUE) & !grepl("Re: ", needed_txt, fixed = TRUE))
  
  if (length(intrested_pos) > 0) {
    
    for (j in intrested_pos) {
      
      if (current_id <= 10) {
        my_table[current_id, 1] = needed_txt[j]
        my_table[current_id, 2] = needed_html[j] %>% html_attr("href")
      }
      
    current_id = current_id + 1
    
    }
    
  }
  
  if (current_id > 10) {
    break
  }
  
  next_page = website %>% html_nodes("a") %>% .[8] %>% html_attr("href")
  URL = paste0("https://www.ptt.cc", next_page, sep = "")
  
}

my_table
```

# Ch 12 簡易網頁App撰寫

# 什麼是網頁應用程式(WebApp)?

- WebApp是讓網站從單純的呈現資訊，進階為更具功能性/互動性的網站系統。

– 前端：使用HTML/CSS/Java Script等技術製作網頁介面（與一般網頁無異）

– 後端：利用預先設定的模組與使用者進行互動，並回傳結果給前端

- 相較於一般的應用程式，webApp有著一些優劣…

– 優勢：跨平台、更新方便

– 劣勢：速度較慢、需要穩定的連線

- 看不懂沒關係，現在我們可以全部都用R語言寫出一個WebApp

# 一個簡單的WebApp(1)

- **[套件『shiny』](http://shiny.rstudio.com/tutorial/)**於2013年推出，它的主要功能是聯結webApp的前端與後端。

– 應該還記得怎樣安裝套件吧！

- 安裝完成後，我們要先建立一個新的資料夾(Myapp)，這個資料夾內以後將裝著兩個R script檔案，分別是ui.R(主管使用者介面)以及server.R(主管伺服器端的處理)。

# 一個簡單的WebApp(2)

- 接著進入Myapp資料夾後，我們要新增一個R script檔案。

# 一個簡單的WebApp(3)

- 接著在檔案內貼上下列程式碼，然後儲存為ui.R

```
library(shiny)

# Define UI for application that plots random distributions 
shinyUI(pageWithSidebar(

  # Application title
  headerPanel("Hello Shiny!"),

  # Sidebar with a slider input for number of observations
  sidebarPanel(
    sliderInput("obs", "Number of observations:", min = 0, max = 1000, value = 500)
  ),

  # Show a plot of the generated distribution
  mainPanel(
    plotOutput("distPlot")
  )
))
```

# 一個簡單的WebApp(4)

- 再新增一個R script檔案，並且貼上下列程式碼，然後儲存為server.R

```
library(shiny)

# Define server logic required to generate and plot a random distribution
shinyServer(function(input, output) {
  
  # Expression that generates a plot of the distribution. The expression is
  # wrapped in a call to renderPlot to indicate that:
  # 
  # 1) It is 'reactive' and therefore should be automatically re-executed
  # when inputs change 2) Its output type is a plot
  output$distPlot = renderPlot({
    
    # generate an rnorm distribution and plot it
    dist = rnorm(input$obs)
    hist(dist)
  })
  
})
```

# 一個簡單的WebApp(5)

- 都儲存完成後，接著點選Run App，你就可以完成你寫的App了。

# 簡單介紹shiny app架構(1)

- 前面已經說過，使用shiny(R package)所撰寫的App，他的基本構造是一個包含ui.R(主管使用者介面)以及server.R(主管伺服器端的處理)的資料夾。
- Shiny app的基本運作流程為：

1. 使用者自ui.R中的給定一個參數。
2. 這個參數傳到server.R裡面，使用反應函數進行計算。
3. 反應完成後，再回傳至ui.R輸出反應結果。

# 簡單介紹shiny app架構(2)

- 下列是剛剛你所貼上的程式碼(ui.R)

```
library(shiny)

# Define UI for application that plots random distributions 
shinyUI(pageWithSidebar(

  # Application title
  headerPanel("Hello Shiny!"),

  # Sidebar with a slider input for number of observations
  sidebarPanel(
    sliderInput("obs", "Number of observations:", min = 0, max = 1000, value = 500)
  ),

  # Show a plot of the generated distribution
  mainPanel(
    plotOutput("distPlot")
  )
))
```

- 其中是以shinyUI()這個函數為開頭，接著選定一個模組，我們使用pageWithSidebar()函數作為模組，此模組內必須包含3個子函數，分別是：

1. headerPanel()用來定義網頁標題
2. sidebarPanel()用來定義的控制選單內含哪些可控參數，本例中只有一個滑動輸入元件sliderInput()，元件為obs
3. mainPanle()則是用來定義輸出區域的輸出結果，本例中只有一個圖片輸出元件plotOutput()，元件為distPlot

# 簡單介紹shiny app架構(3)

- 下列是剛剛你所貼上的程式碼(server.R)

```
library(shiny)

# Define server logic required to generate and plot a random distribution
shinyServer(function(input, output) {

    # Expression that generates a plot of the distribution. The expression is
    # wrapped in a call to renderPlot to indicate that:
    # 
    # 1) It is 'reactive' and therefore should be automatically re-executed
    # when inputs change 2) Its output type is a plot
    output$distPlot = renderPlot({

        # generate an rnorm distribution and plot it
        dist = rnorm(input$obs)
        hist(dist)
    })

})
```

- 其中是以shinyServer()這個函數為開頭，裡面包含著一個函數function()要求你指定input及output，由於我們只要做一個反應函數，由於我們想要畫一張圖，所以使用renderPlot()函數，在裡面我們指定它畫圖的過程，並且將結果儲存在output裡面的distPlot。
- 這個畫圖的過程很簡單，就是先指定一個數字（由input$obs提供，也就是剛剛在ui.R中使用者所給定的參數)，然後要求R使用rnorm()隨機產生n個平均數為0，標準差為1的數列，而這個數列儲存在dist元件內。接著在以hist(dist)畫出這個數列的直方圖。
- 因此，在renderPlot()函數內，我們根據使用者指定的參數(input$obs)產生了一張直方圖，而這張直方圖將會儲存在output裡面的distPlot。
- 接著這個物件distPlot就會回到ui.R中，而根據我們在ui.R中所下的指令，他將會使用plotOutput()函數使這張圖形呈現在輸出區上。

Note：所有的輸入元件都存取在input這個List內；而所有的輸出元件都存取在output這個List內。

# 簡單介紹shiny app架構(4)

- 至此為止，我們已經學會了webApp的基本寫法。然而這時候若需要進一步的增加它的應用面，我們需要的是學習更多R裡面的函數，讓我們的App可以擁有更強大的功能。
- 請在R內練習下列這段程式碼的使用，並試圖改變裡面的obs,M,S,Coler的數字，了解他的功能

```
obs = 500
M = 170
S = 10
Coler = "blue"
dist = rnorm(obs, mean = M, sd = S)
hist(dist, col = Coler)
```

# 簡單介紹shiny app架構(5)

- 在剛剛的練習中我們已經清楚了在R裡面，改變參數可以改變圖形的常態分布，接著我們可以開始增加這些參數至我們剛剛寫的App內。
- 除了已經存在的obs之外，我們將繼續增加M,S,Coler在我們的控制區域之內。
- ui.R

```
library(shiny)

# Define UI for application that plots random distributions 
shinyUI(pageWithSidebar(

  # Application title
  headerPanel("Hello Shiny!"),

  # Sidebar with inputs for number of observations, mean, SD, and coler.
  sidebarPanel(
    sliderInput("obs", "Number of observations:", min = 0, max = 1000, value = 500),
    numericInput("M", "Mean of this normal distribution:", min = -200, max = 200, value = 100),
    numericInput("S", "SD of this normal distribution:", min = 0, max = 50, value = 10),
    radioButtons("Color", "Select the color of histogram:", choices = c("Red" = "red", "Blue" = "blue", "Green" = "green"))
  ),

  # Show a plot of the generated distribution
  mainPanel(
    plotOutput("distPlot")
  )
))
```

- server.R (注意在server.R之中，所有在ui.R內所出現的參數前面都要加上“input$”，表示他其實是在input這個List之內的東西。)

```
library(shiny)

# Define server logic required to generate and plot a random distribution
shinyServer(function(input, output) {

    # Expression that generates a plot of the distribution. The expression is
    # wrapped in a call to renderPlot to indicate that:
    # 
    # 1) It is 'reactive' and therefore should be automatically re-executed
    # when inputs change 2) Its output type is a plot
    output$distPlot = renderPlot({

        # generate an rnorm distribution and plot it
        dist = rnorm(input$obs,mean=input$M,sd=input$S)
        hist(dist,col=input$Color)
    })

})
```

# 自訂函數與shiny app(1)

- 我們先把R做為一個計算機來使用，並且使用函數功能做一些較複雜的運算。
- 下面這個範例是我們前面的課程所做到的費波納奇數列，

```
x = c(1, 1)

for (i in 3:20) {
  x[i] = x[i-1] + x[i-2]
}

x
```

- 接著，我們把它包為一個函數(請試試它的功能)

```
Fibonacci = function (a, b, last.seq) {
  if (last.seq < 3) {
    cat("last.seq必須大於等於3。")
  } else {
    x = c(a, b)
    
    for (i in 3:last.seq) {
      x[i] = x[i-1] + x[i-2]
    }
    
    x
  }
}

Fibonacci(1, 1, 20)
Fibonacci(2, 4, 2)
```

# 自訂函數與shiny app(2)

- 在R裡面我們學會函數運算之後，接著我們會希望其他人也可以輕易的使用我們剛剛設定好的函數，因此我們會希望將他寫成像這樣子的App，供大家使用。
- ui.R

```
library(shiny)

# Define UI for application that calculate the needed sample size 
shinyUI(pageWithSidebar(

  # Application title
  headerPanel("My App"),

  # Sidebar with numeric inputs
  sidebarPanel(
    numericInput("a", "The first value of sequence:", min = -100, max = 100, value = 1),
    numericInput("b", "The second value of sequence:", min = -100, max = 100, value = 1),
    numericInput("last.seq", "The length of sequence:", min = 3, max = 30, value = 20)
  ),

  # Show the outcome
  mainPanel(
    verbatimTextOutput("Seq")
  )
))
```

- server.R

```
library(shiny)

# Your function
Fibonacci = function (a, b, last.seq) {
  if (last.seq < 3) {
    cat("last.seq必須大於等於3。")
  } else {
    x = c(a, b)
    
    for (i in 3:last.seq) {
      x[i] = x[i-1] + x[i-2]
    }
    
    x
  }
}

# Define server logic required to calculate the needed sample size
shinyServer(function(input, output) {

    output$Seq = renderPrint({
      Fibonacci(input$a, input$b, input$last.seq)
    })

})
```

# conditionalPanel的應用(1)

- 如果可以的話，我們會更希望兩種計算工具可以合在同個App內，那我們在ui.R中會需要一個新的函數，叫做conditionalPanel()

– conditionalPanel()可以讓我們的控制bar僅在特定條件下出現

- 這邊有個範例，設計一個按鈕選擇我要產生常態分布還是t分佈

– 常態分布必須要有兩個參數(平均數&標準差)決定，而t分布則必須要由一個參數決定(自由度)，因此我們就必須設計當選擇常態分不時，控制區要出現的是平均數&標準差；若選擇了t分布，控制區要出現的則是自由度

- ui.R

```
library(shiny)
shinyUI(pageWithSidebar(
  
  headerPanel("Generating distribution"),
  
  sidebarPanel(
    selectInput("method", "Choose distribution:", choices=c("Normal"="norm", "Student t"="st")),
    helpText("Setting parameter(s) for distribution model"),
    conditionalPanel(condition="input.method=='norm'",
                     numericInput(inputId="mu", label="mean", value=0),
                     numericInput(inputId="sd", label="standard deviation", value=1, min=0)
    ),
    conditionalPanel(condition="input.method=='st'",
                     numericInput(inputId="df", label="Df", value=10, min=1)
    ),
    sliderInput(inputId="obs", 
                label="Number of observations:", 
                min = 1, max = 1000, value = 500)
  ),
  
  mainPanel(
    plotOutput("distPlot")
  )

))
```

- server.R

```
library(shiny)

shinyServer(function(input, output) {
    output$distPlot <- renderPlot({
        if (input$method == "norm") 
            {dist <- rnorm(input$obs, mean = input$mu, sd = input$sd)}
        if (input$method == "st") 
            {dist <- rt(input$obs, df = input$df)}
        hist(dist)
    })
})
```

# Ch 13 網頁App之前後端優化

# 增加介面複雜度(1)

- 下列是幾個基本的介面參數

```
##                  Functions    Characteristic
## 1        pageWithSidebar()    Main structure
## 2              fluidPage()    Main structure
## 3             navbarPage()    Main structure
## 4 tabsetPanel()+tabPanel()          Sub page
## 5           navlistPanel()   navigation list
## 6      fluidRow()+column() Splitted function
## 7          absolutePanel()     movable panel
```

– 請在[這裡](https://linchin.ndmctsgh.edu.tw/data/UI example.rar)下載介面參數範例

- 利用利用Datatable設計互動程序

– ui.R

```
library(shiny)
library(DT)

fluidPage(
  
  h1('A Client-side Table'),
  
  fluidRow(
    column(6, DT::dataTableOutput('x1')),
    column(6, plotOutput('x2', width = "500px", height = "500px"))
  )
  
)
```

– server.R

```
library(shiny)
library(DT)

data(cars)
dat = cars

shinyServer(function(input, output, session) {
  
  output$x1 = DT::renderDataTable({
    Result = DT::datatable(dat)
    return(Result)
  })
  
  output$x2 = renderPlot({
    selection = as.numeric(input$x1_rows_selected)
    X = dat[,1]
    Y = dat[,2]
    plot(X,Y)
    if (length(selection)!=0) {points(X[selection],Y[selection], pch = 19, cex = 2, col = "red")}
  })
  
})
```

# 在網頁應用程式中的高耗時程序

- 因為這個程序太耗時了，使用者很可能以為程式壞了，因此我們希望有一個按鍵，讓使用者自己決定運算開始的時機

– reactive()、eventReactive()可以幫助我們做到這個功能

– 另外，我們再介紹進度條函數:withProgress()，這可以提示使用者目前正在運行中。

- ui.R

```
library(shiny)

shinyUI(pageWithSidebar(
  
  headerPanel("My App"),
  
  sidebarPanel(
    numericInput("max.x", "The search range of prime number:", min = 2, max = 100000, value = 10000),
    actionButton("submit",strong("Start to analyze!"),icon("list-alt"))
  ),
  
  mainPanel(
    verbatimTextOutput("Seq")
  )
))
```

- server.R

```
library(shiny)

shinyServer(function(input, output) {
  
  RESULT = eventReactive(input$submit,{
    if (is.null(input$max.x)) {return()} else {
      withProgress(message = "In processing...",value=0,{
        
        x = 2:input$max.x
        answer.x = rep(TRUE, input$max.x-1)
        indexes = 1:(input$max.x/2-1) * 2
        answer.x[indexes + 1] = FALSE
        
        for (i in indexes) {
          pos = which(answer.x[1:((i-1)/3)])
          for (j in pos) {
            if (x[i] %% x[j] == 0) {
              answer.x[i] = FALSE
              break
            }
          }
          incProgress(1/length(indexes))
        }
        
        tail(x[answer.x], 1)
        
      })
    }
  })
  
  
  output$Seq = renderPrint({
    result = RESULT()
    if (is.null(result)) {return()} else {
      return(result)
    }
  })
  
})
```

# Ch 14 圖形化互動App

# 創造互動式圖形(1)

- 現在我們已經學會了一堆元件能增加與使用者的互動性，那圖像能否與使用者進行互動?答案是可以的，請複製貼上以下ui&server。

– ui.R

```
library(shiny)

fluidPage(
  fluidRow(
    column(width = 4,
           plotOutput("plot1", height = 350,
                      click = "plot_click",
                      dblclick = dblclickOpts(id = "plot_dblclick"),
                      hover = hoverOpts(id = "plot_hover"),
                      brush = brushOpts(id = "plot_brush")
           )
    )
  ),
  fluidRow(
    column(width = 3,
           verbatimTextOutput("click_info")
    ),
    column(width = 3,
           verbatimTextOutput("dblclick_info")
    ),
    column(width = 3,
           verbatimTextOutput("hover_info")
    ),
    column(width = 3,
           verbatimTextOutput("brush_info")
    )
  )
)
```

– server.R

```
library(shiny)

data(cars)
dat = cars

shinyServer(function(input, output) {
  output$plot1 <- renderPlot({
    plot(dat)
  })
  
  output$click_info <- renderPrint({
    cat("input$plot_click:\n")
    str(input$plot_click)
  })
  output$hover_info <- renderPrint({
    cat("input$plot_hover:\n")
    str(input$plot_hover)
  })
  output$dblclick_info <- renderPrint({
    cat("input$plot_dblclick:\n")
    str(input$plot_dblclick)
  })
  output$brush_info <- renderPrint({
    cat("input$plot_brush:\n")
    str(input$plot_brush)
  })
  
})
```

# 創造互動式圖形(2)

- 我們可以利用滑鼠事件讓R能做些回應，舉例來說，我們可以畫兩張圖一左一右，右邊的圖是左邊框起來的區域，或是直接在同張圖上放大縮小

– 這邊需要用到兩個新函數：reactiveValues()、observe()和observeEvent()

- ui.R

```
library(shiny)

fluidPage(
  fluidRow(
    column(width = 4,
           plotOutput("plot1", height = 400,
                      brush = brushOpts(id = "plot1_brush", resetOnNew = TRUE))
    ),
    column(width = 4,
           plotOutput("plot2", height = 400)
    ),
    column(width = 4,
           plotOutput("plot3", height = 400,
                      dblclick = "plot3_dblclick",
                      brush = brushOpts(id = "plot3_brush", resetOnNew = TRUE))
    )
  )
)
```

- server.R

```
library(shiny)

data(cars)
dat = cars

shinyServer(function(input, output) {
  
  ranges1 = reactiveValues(x = NULL, y = NULL)
  
  observe({
    brush1 = input$plot1_brush
    if (!is.null(brush1)) {
      ranges1$x = c(brush1$xmin, brush1$xmax)
      ranges1$y = c(brush1$ymin, brush1$ymax)
    } else {
      ranges1$x = NULL
      ranges1$y = NULL
    }
  })
  
  output$plot1 <- renderPlot({
    plot(dat)
  })
  
  output$plot2 <- renderPlot({
    plot(dat, xlim = ranges1$x, ylim = ranges1$y)
  })
  
  ranges2 <- reactiveValues(x = NULL, y = NULL)
  
  output$plot3 <- renderPlot({
    plot(dat, xlim = ranges2$x, ylim = ranges2$y)
  })
  
  observeEvent(input$plot3_dblclick, {
    brush2 <- input$plot3_brush
    if (!is.null(brush2)) {
      ranges2$x <- c(brush2$xmin, brush2$xmax)
      ranges2$y <- c(brush2$ymin, brush2$ymax)
    } else {
      ranges2$x <- NULL
      ranges2$y <- NULL
    }
  })
  
})
```

## Google圖表在網頁應用程式的應用(1)

- 套用別人的東西能夠更快的得到更好的功能，讓我們介紹Google圖表，而他可以很好的跟App結合

– 大家可以在**[googleVis examples](https://cran.r-project.org/web/packages/googleVis/vignettes/googleVis_examples.html)**找到一些例子

- 在我們的WebApp中，我們可以使用htmlOutput來輸出Google charts，讓我們所呈現互動式的圖表

– 請複製貼上以下範例在Rstudio中

– 請至[這裡](https://linchin.ndmctsgh.edu.tw/data/Example_data.csv)下載範例資料

```
dat = read.csv("Example_data.csv", header = TRUE)
head(dat)
##       eGFR Disease Survival.time Death Diabetes Cancer      SBP      DBP
## 1 34.65379       1     0.4771037     0        0      1 121.2353 121.3079
## 2 37.21183       1     3.0704424     0        1      1 122.2000 122.6283
## 3 32.60074       1     0.2607117     1        0      0 118.9136 121.7621
## 4 29.68481       1            NA    NA        0      0 118.2212 112.7043
## 5 28.35726       0     0.1681673     1        0      0 116.7469 115.7705
## 6 33.95012       1     1.2238556     0        0      0 119.9936 116.3872
##   Education Income
## 1         2      0
## 2         2      0
## 3         0      0
## 4         1      0
## 5         0      0
## 6         1      0
```

- 套件『googleVis』結合了google提供的API，讓我們能在R裡面畫出google圖表

```
library(googleVis)
```

- 這個套件在R的簡單應用可以參考：**[googleVis examples](https://cran.r-project.org/web/packages/googleVis/vignettes/googleVis_examples.html)**

# Google圖表在網頁應用程式的應用(2)

- 接著我們來學散布圖

```
newdat = dat[,c("SBP", "DBP")]
SC1 = gvisScatterChart(newdat)
plot(SC1)
```

- 透過函數「help」可以找到他的一些變化

```
newdat = dat[,c("eGFR", "SBP")]
SC2 = gvisScatterChart(newdat,
                        options=list(
                        title = "eGFR vs SBP",
                        legend = "none",
                        colors="['#ff0000']",
                        pointSize = 2,
                        explorer="{actions: ['dragToZoom',
                                  'rightClickToReset'],
                                  maxZoomIn:0.05}"
                        ))
plot(SC2)
```

- 如果想要把這些圖片儲存出去，我們需要使用下面的方式

```
cat(SC2$html$chart, file = "SC2.html")
```

## Google圖表在網頁應用程式的應用(3)

- 想在網頁中增加Google圖表並不困難，現在讓我們展示一個範例

– ui.R

```
library(shiny)
library(googleVis)

fluidPage(
  htmlOutput("chart1")
)
```

– server.R

```
library(shiny)
library(googleVis)

shinyServer(function(input, output, session) {
  
  output$chart1 <- renderGvis({
    
    newdat = data.frame(x1 = rnorm(100), x2 = rnorm(100))
    SC1 = gvisScatterChart(newdat)
    SC1
    
  })
  
})
```

請在[這裡](https://linchin.ndmctsgh.edu.tw/data/Example.txt)下載練習用檔案

- ui.R

```
library(shiny)
library(googleVis)

shinyUI(pageWithSidebar(
  
  headerPanel("Linear regression for two continuous variables."), 
  
  sidebarPanel(
    fileInput(inputId="files", label=h4("Upload your data file:"), multiple=FALSE, accept="text/plain"),
    helpText("Note: you only can upload the .txt file."),
    uiOutput("choose_columns1"),   #這裡是關鍵
    uiOutput("choose_columns2"),   #這裡是關鍵
    radioButtons("method", "What is the method to analysis?", choices = c("Pearson correlation" = "pearson", "Spearman correlation" = "spearman")),
    radioButtons("Color", "Select the color of histogram:", choices = c("Red" = "#ff0000", "Blue" = "#0000ff", "Green" = "#00ff00"))
  ),
  
  mainPanel(
    verbatimTextOutput("summary"),
    htmlOutput("plot")
  )  
  
))
```

- server.R

```
library(shiny)
library(googleVis)

shinyServer(function(input, output) {
  
  DATA <- reactive({
    if (is.null(input$files)) {return()} else {
      dat <- read.table(input$files$datapath,header=T)
      return(dat) 
    }
  })
  
  output$choose_columns1 <- renderUI({  #這裡是關鍵
    dat = DATA()
    if (is.null(dat)) {return()} else {
      colnames <- colnames(dat)
      selectInput("Y", h4("Choose a dependence variable:"), choices = colnames)
    }
  })
  
  output$choose_columns2 <- renderUI({  #這裡是關鍵
    dat = DATA()
    if (is.null(dat)|is.null(input$Y)) {return()} else {
      colnames <- colnames(dat)
      selectInput("X", h4("Choose a independence variable:"), choices = colnames[which(colnames!=input$Y)])
    }
  })
  
  output$summary <- renderPrint({
    dat = DATA()
    if (is.null(dat)|is.null(input$Y)|is.null(input$X)) {return()} else {
      X <- dat[,input$X]  #這裡是關鍵
      Y <- dat[,input$Y]  #這裡是關鍵
      Result=cor.test(X,Y,method=input$method)
      return(Result)
    }  
  })
  
  output$plot <- renderGvis({
    dat = DATA()
    if (is.null(dat)|is.null(input$Y)|is.null(input$X)) {return()} else {
      X <- dat[,input$X]  #這裡是關鍵
      Y <- dat[,input$Y]  #這裡是關鍵
      newdat = data.frame(X = X, Y = Y)
      SC2 = gvisScatterChart(newdat,
                             options=list(
                               legend = "none",
                               colors=paste0("['", input$Color, "']"),
                               pointSize = 2,
                               explorer="{actions: ['dragToZoom',
                                  'rightClickToReset'],
                                  maxZoomIn:0.05}"
                             ))
      SC2
      
    }  
  })
  
})
```

# Ch 15 經典網頁App分享

# 網路爬蟲程式

- 還記不記得之前我們在寫爬蟲程式的時候有個有趣的例子，是在PPT上面找最新的徵男文！

– 想要找的話你可以複製貼上下面的程式碼：

```
library(rvest)

my_table = matrix("", nrow = 10, ncol = 4)
colnames(my_table) = c("Title", "url", "ID", "time")

URL = "https://www.ptt.cc/bbs/AllTogether/index.html"
current_id = 1

for (i in 1:10) {
  
  website = read_html(URL)
  needed_html = website %>% html_nodes("a")
  needed_txt = needed_html %>% html_text()
  intrested_pos = grep("[徵男]", needed_txt, fixed = TRUE)
  
  if (length(intrested_pos) > 0) {
    
    for (j in intrested_pos) {
      
      if (current_id <= 10) {
        my_table[current_id, 1] = needed_txt[j]
        my_table[current_id, 2] = needed_html[j] %>% html_attr("href")
      }
      
    current_id = current_id + 1
    
    }
    
  }
  
  if (current_id > 10) {
    break
  }
  
  next_page = website %>% html_nodes("a") %>% .[8] %>% html_attr("href")
  URL = paste0("https://www.ptt.cc", next_page, sep = "")
  
}

for (i in 1:nrow(my_table)) {
  
  sub_URL = paste("https://www.ptt.cc", my_table[i, 2], sep = "")
  sub_website = read_html(sub_URL)
  article_info = sub_website %>% html_nodes(".article-meta-value") %>% html_text()
  my_table[i, 3] = article_info[1]
  my_table[i, 4] = article_info[4]
  
}

my_table
```

- 讓我們把他改寫成Web吧！(這樣才能分享給不會寫程式的單身人士使用)，由於整體運行時間可能滿長的，所以我們的程式需要有起始按鍵，並且要設有進度條，讓我們看看完成品：
- ui.R

```
library(shiny)
library(rvest)

shinyUI(navbarPage("徵男文自動尋找系統",
                   tabPanel("近期文章搜尋",
                            actionButton("submit", strong("按我開始找")),
                            br(),
                            DT::dataTableOutput("view")
                   )
))
```

- server.R

```
library(shiny)
library(rvest)

shinyServer(function(input, output) {
  
  MY_TABLE = eventReactive(input$submit, {
    
    my_table = matrix("", nrow = 10, ncol = 4)
    colnames(my_table) = c("Title", "url", "ID", "time")
    
    URL = "https://www.ptt.cc/bbs/AllTogether/index.html"
    current_id = 1
    
    withProgress(message = "尋找文章中...", value = 0, {
    
      for (i in 1:10) {
        
        website = read_html(URL)
        needed_html = website %>% html_nodes("a")
        needed_txt = needed_html %>% html_text()
        intrested_pos = grep("[徵男]", needed_txt, fixed = TRUE)
        
        if (length(intrested_pos) > 0) {
          
          for (j in intrested_pos) {
            
            if (current_id <= 10) {
              my_table[current_id, 1] = needed_txt[j]
              my_table[current_id, 2] = needed_html[j] %>% html_attr("href")
            }
            
            current_id = current_id + 1
            
          }
          
        }
        
        if (current_id > 10) {
          break
        }
        
        next_page = website %>% html_nodes("a") %>% .[8] %>% html_attr("href")
        URL = paste0("https://www.ptt.cc", next_page, sep = "")
        
        incProgress(1/10)
        
      }
      
    })
    
    withProgress(message = "擷取文章資訊中...", value = 0, {
      
      for (i in 1:nrow(my_table)) {
        
        sub_URL = paste("https://www.ptt.cc", my_table[i, 2], sep = "")
        sub_website = read_html(sub_URL)
        article_info = sub_website %>% html_nodes(".article-meta-value") %>% html_text()
        my_table[i, 3] = article_info[1]
        my_table[i, 4] = article_info[4]
        
        incProgress(1/nrow(my_table))
        
      }
      
    })
    
    my_table
    
  })
  
  output$view = DT::renderDataTable({
    dat = MY_TABLE()
    if (is.null(dat)) {return()} else {
      dat = data.frame(dat, stringsAsFactors = FALSE)
      Result = DT::datatable(dat)
      return(Result)
    }
  })
  
})
```

- 老實說這樣並不友善，有沒有可能直接讓使用者點擊喜歡的文章就能超連結到該篇文章呢?答案當然是可以的！

– 這裡我們會用到一些HTML的語法，還記得超連結的標籤是什麼嗎?

- ui.R

```
library(shiny)
library(rvest)

shinyUI(navbarPage("徵男文自動尋找系統",
                   tabPanel("近期文章搜尋",
                            actionButton("submit", strong("按我開始找")),
                            br(),
                            DT::dataTableOutput("view")
                   )
))
```

- server.R

```
library(shiny)
library(rvest)

shinyServer(function(input, output) {
  
  MY_TABLE = eventReactive(input$submit, {
    
    my_table = matrix("", nrow = 10, ncol = 4)
    colnames(my_table) = c("Title", "url", "ID", "time")
    
    URL = "https://www.ptt.cc/bbs/AllTogether/index.html"
    current_id = 1
    
    withProgress(message = "尋找文章中...", value = 0, {
    
      for (i in 1:10) {
        
        website = read_html(URL)
        needed_html = website %>% html_nodes("a")
        needed_txt = needed_html %>% html_text()
        intrested_pos = grep("[徵男]", needed_txt, fixed = TRUE)
        
        if (length(intrested_pos) > 0) {
          
          for (j in intrested_pos) {
            
            if (current_id <= 10) {
              my_table[current_id, 1] = needed_txt[j]
              my_table[current_id, 2] = needed_html[j] %>% html_attr("href")
            }
            
            current_id = current_id + 1
            
          }
          
        }
        
        if (current_id > 10) {
          break
        }
        
        next_page = website %>% html_nodes("a") %>% .[8] %>% html_attr("href")
        URL = paste0("https://www.ptt.cc", next_page, sep = "")
        
        incProgress(1/10)
        
      }
      
    })
    
    withProgress(message = "擷取文章資訊中...", value = 0, {
      
      for (i in 1:nrow(my_table)) {
        
        sub_URL = paste("https://www.ptt.cc", my_table[i, 2], sep = "")
        sub_website = read_html(sub_URL)
        article_info = sub_website %>% html_nodes(".article-meta-value") %>% html_text()
        my_table[i, 3] = article_info[1]
        my_table[i, 4] = article_info[4]
        
        incProgress(1/nrow(my_table))
        
      }
      
    })
    
    my_table
    
  })
  
  output$view = DT::renderDataTable({
    dat = MY_TABLE()
    if (is.null(dat)) {return()} else {
      dat = data.frame(dat, stringsAsFactors = FALSE)
      dat[,2] = paste('<a href="https://www.ptt.cc', dat[,2], '">', dat[,2], '</a>', sep = "")
      Result = DT::datatable(dat, escape = FALSE)
      return(Result)
    }
  })
  
})
```